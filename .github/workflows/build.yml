name: CI

on: [push, pull_request, workflow_dispatch]

jobs:
  style-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run static checks.
        run: python3 util/check.py

  linux-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PCRE2
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcre2-dev
      - name: Run the Makefile.
        run: make all
      - name: Run tests.
        run: python3 util/test.py
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-linux
          path: saynaa

  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PCRE2 (Regex Dependency)
        run: |
          # 1. Install the static library
          vcpkg install pcre2:x64-windows-static
          
          # 2. Ensure the deps folders exist
          $includeDir = "deps/pcre2/include"
          $libDir = "deps/pcre2/lib"
          if (!(Test-Path $includeDir)) { New-Item -ItemType Directory -Force -Path $includeDir }
          if (!(Test-Path $libDir)) { New-Item -ItemType Directory -Force -Path $libDir }
          
          # 3. Locate vcpkg installation root (handling path mismatches)
          $vcpkgRoot = "C:/vcpkg"
          if (!(Test-Path $vcpkgRoot)) { $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT }

          # 4. Copy Headers
          Copy-Item "$vcpkgRoot/installed/x64-windows-static/include/pcre2*" -Destination "$includeDir/" -Force
          
          # 5. Copy Lib (using wildcard to find pcre2-8.lib or pcre2-8-static.lib)
          $sourceLib = Get-ChildItem -Path "$vcpkgRoot/installed/x64-windows-static/lib/pcre2-8*.lib" | Select-Object -First 1
          if ($sourceLib) {
              Copy-Item $sourceLib.FullName -Destination "$libDir/pcre2-8-static.lib" -Force
              Write-Host "Successfully copied $($sourceLib.Name) to pcre2-8-static.lib"
          } else {
              Write-Error "Could not find PCRE2 library in $vcpkgRoot"
              exit 1
          }
        shell: pwsh

      - name: Run build batch script
        run: cmd /c build.bat

      - name: Run tests
        run: python util/test.py
        
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-windows
          path: saynaa.exe

  macos-build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PCRE2
        run: brew install pcre2
      - name: Run the Makefile.
        run: make all
      - name: Run tests.
        run: python3 util/test.py
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-mac
          path: saynaa
